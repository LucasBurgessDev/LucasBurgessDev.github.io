name: Gemini Atomic Evolution
on:
  schedule:
    - cron: '0 0 * * 1' # Runs every Monday
  workflow_dispatch: # Allows you to run it manually for testing

jobs:
  atomic-upgrades:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: dev # Targets the dev branch specifically

      - name: Generate Upgrade List
        id: get_tasks
        uses: google-github-actions/run-gemini-cli@main # Using @main to fix version error
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }} # Ensure this secret is in GitHub Settings
          command: >
            Analyze the /src folder. 
            Identify 3 distinct, high-impact improvements: 
            1. SECURITY: Fix potential vulnerabilities.
            2. PERFORMANCE: Optimize logic or assets.
            3. PORTFOLIO FEATURE: Suggest a new useful component for a blog/portfolio.
            Output ONLY a comma-separated list of short titles (no spaces).
            Example: SecurityFix,PerfOptimize,NewReadingTimeComponent

      - name: Process Tasks Individually
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TASKS: ${{ steps.get_tasks.outputs.response }}
        run: |
          # Clean the response and split into an array
          CLEAN_TASKS=$(echo "$TASKS" | tr -d '[:space:]')
          IFS=',' read -ra ADDR <<< "$CLEAN_TASKS"
          
          for task in "${ADDR[@]}"; do
            echo "Processing Task: $task"
            
            # Reset to dev for each new task branch
            git checkout dev
            git checkout -b "gemini/upgrade-$task"
            
            # Run the specific task
            # Note: Ensure the gemini-cli is available in the runner environment
            # or use the action again within the loop for each specific task mod.
            
            echo "Requesting code changes for $task..."
            
            # Commit and Push
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            # (Logic for Gemini to write files would go here via the CLI)
            # This script assumes Gemini CLI modifies the local workspace.
            
            git add .
            git commit -m "ai: $task implementation" || echo "No changes to commit"
            git push origin "gemini/upgrade-$task" --force
            
            # Create the PR
            gh pr create \
              --base dev \
              --head "gemini/upgrade-$task" \
              --title "ðŸš€ AI Upgrade: $task" \
              --body "Gemini suggested this individual upgrade for: $task. Review for security and performance."
          done
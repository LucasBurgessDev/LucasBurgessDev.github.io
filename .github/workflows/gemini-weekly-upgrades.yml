name: Gemini React Atomic Evolution
on:
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  evolution:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Gemini React Engineer
        uses: google-github-actions/run-gemini-cli@main
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          command: >
            ACT AS: A Senior React Engineer.
            CONTEXT: Portfolio/Blog website. 
            CONSTRAINTS: Do NOT use Tailwind or Lucide icons. Use standard CSS/Modules.
            
            TASKS:
            1. SECURITY: Fix React-specific vulnerabilities (XSS, insecure props).
            2. PERFORMANCE: Optimize re-renders (Memo, Callback) and image loading.
            3. FEATURE: Create one new React component (e.g., ReadingProgress, ProjectGallery).
            
            OUTPUT: Apply code directly. Use commit messages 'task:Security', 'task:Perf', 'task:Feature'.

      - name: Validate and Create PRs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Iterate through the specific tasks created by Gemini
          COMMITS=$(git log dev..HEAD --oneline | grep "task:")
          
          while read -r line; do
            HASH=$(echo $line | awk '{print $1}')
            NAME=$(echo $line | awk '{print $2}' | sed 's/task://')
            BRANCH="ai/react-$NAME-$(date +%s)"
            
            git checkout -b "$BRANCH" "$HASH"
            
            echo "--- Validating $NAME ---"
            # ONLY create PR if build and test pass
            if npm run build && npm test; then
              git push origin "$BRANCH"
              gh pr create \
                --base dev \
                --head "$BRANCH" \
                --title "ðŸš€ React $NAME: Automated Upgrade" \
                --body "Gemini generated this $NAME upgrade. Build and tests passed successfully."
            else
              echo "Validation failed for $NAME. Skipping PR."
            fi
            
            git checkout dev
          done <<< "$COMMITS"
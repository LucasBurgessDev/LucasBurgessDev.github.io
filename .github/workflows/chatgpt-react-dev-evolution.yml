name: ChatGPT React Dev Evolution

"on":
  schedule:
    - cron: "0 0 * * 1"
  workflow_dispatch:
    inputs:
      task:
        description: "Task to run: all, Security, Perf, Feature"
        required: false
        default: "all"

concurrency:
  group: chatgpt-react-dev-evolution
  cancel-in-progress: true

jobs:
  evolve:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    strategy:
      fail-fast: false
      matrix:
        task: [Security, Perf, Feature]

    env:
      BASE_BRANCH: dev
      SRC_DIR: src
      TASK_INPUT: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.task || 'all' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0

      - name: Validate and maybe skip this matrix task
        shell: bash
        run: |
          set -euo pipefail

          # Normalize the manual input, schedules behave like "all"
          TASK_INPUT="${TASK_INPUT:-all}"

          case "$TASK_INPUT" in
            all|Security|Perf|Feature) ;;
            *)
              echo "Invalid task input: '$TASK_INPUT'"
              echo "Allowed: all, Security, Perf, Feature"
              exit 1
              ;;
          esac

          if [ "$TASK_INPUT" != "all" ] && [ "$TASK_INPUT" != "${{ matrix.task }}" ]; then
            echo "Skipping matrix task '${{ matrix.task }}' because TASK_INPUT='$TASK_INPUT'"
            exit 0
          fi

      - name: Prepare tools
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Create task branch
        id: branch
        shell: bash
        run: |
          set -euo pipefail
          TS="$(date +%s)"
          BRANCH="chatgpt/${{ matrix.task }}-${TS}"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          git checkout -b "$BRANCH"

      - name: Build repository context
        id: ctx
        shell: bash
        run: |
          set -euo pipefail

          : > /tmp/context.txt
          echo "### TREE" >> /tmp/context.txt

          if [ -d "${SRC_DIR}" ]; then
            (cd "${SRC_DIR}" && find . -maxdepth 4 -type f | sed 's|^\./||' | sort) >> /tmp/context.txt
          else
            echo "SRC_DIR '${SRC_DIR}' not found" >> /tmp/context.txt
          fi

          echo "" >> /tmp/context.txt
          echo "### KEY FILES (truncated)" >> /tmp/context.txt

          FILES=""
          for f in "package.json" "package-lock.json" "pnpm-lock.yaml" "yarn.lock" \
                   "${SRC_DIR}/index.js" "${SRC_DIR}/index.jsx" "${SRC_DIR}/main.jsx" \
                   "${SRC_DIR}/App.jsx" "${SRC_DIR}/App.tsx" "${SRC_DIR}/App.js"; do
            if [ -f "$f" ]; then FILES="$FILES $f"; fi
          done

          if [ -z "$FILES" ] && [ -d "${SRC_DIR}" ]; then
            FILES="$(find "${SRC_DIR}" -type f \( -name "*.js" -o -name "*.jsx" -o -name "*.ts" -o -name "*.tsx" -o -name "*.css" \) | head -n 12)"
          fi

          for f in $FILES; do
            echo "" >> /tmp/context.txt
            echo "FILE: $f" >> /tmp/context.txt
            echo "-----" >> /tmp/context.txt
            sed -n '1,240p' "$f" >> /tmp/context.txt
          done

          echo "context_path=/tmp/context.txt" >> "$GITHUB_OUTPUT"

      - name: Ask ChatGPT for a patch
        id: patch
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${OPENAI_API_KEY:-}" ]; then
            echo "Missing secret OPENAI_API_KEY"
            exit 1
          fi

          TASK="${{ matrix.task }}"

          SYSTEM_PROMPT=$'Return ONLY a unified diff patch that can be applied with `git apply`.\nNo explanations, no markdown, no extra text.\nConstraints: no Tailwind, no Lucide, use standard React and CSS.\nIf no change is needed, return an empty response.'

          USER_PROMPT=$(cat <<'EOF'
We will modify a React repository.
Task: __TASK__

Rules:
- Output must be a unified diff starting with "diff --git" for each changed file.
- Make changes only under src/ (and CSS files used by src) unless package changes are strictly required.
- Keep changes minimal, safe, and buildable.
- Prefer small, targeted edits.
- If creating a new component (Feature task), add it under src/components/ and wire it into the app minimally.

For Security:
- Remove obvious unsafe patterns, unsafe URL handling, eval-like behavior.
- Improve sanitization or encoding where appropriate.

For Perf:
- Reduce unnecessary re-renders or expensive work in render where clearly beneficial.
- Avoid premature optimization.

For Feature:
- Add one new useful React component consistent with existing patterns, with standard CSS.

Repository context follows.
EOF
)
          USER_PROMPT="${USER_PROMPT/__TASK__/$TASK}"
          USER_PROMPT="${USER_PROMPT}"$'\n\n'"$(cat "${{ steps.ctx.outputs.context_path }}")"

          RESPONSE="$(curl -sS https://api.openai.com/v1/responses \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -d "$(jq -n \
              --arg model "gpt-5" \
              --arg instructions "$SYSTEM_PROMPT" \
              --arg input "$USER_PROMPT" \
              '{model: $model, instructions: $instructions, input: $input}')" )"

          PATCH_TEXT="$(echo "$RESPONSE" | jq -r '.output_text // ""')"
          printf "%s" "$PATCH_TEXT" > /tmp/changes.patch

          if [ -n "$PATCH_TEXT" ] && ! head -n 1 /tmp/changes.patch | grep -q "^diff --git"; then
            echo "Model did not return a unified diff"
            echo "$PATCH_TEXT" | head -n 80
            exit 1
          fi

          echo "patch_path=/tmp/changes.patch" >> "$GITHUB_OUTPUT"

      - name: Apply patch
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -s "${{ steps.patch.outputs.patch_path }}" ]; then
            echo "Empty patch for task ${{ matrix.task }}: no changes"
            exit 0
          fi
          git apply --whitespace=fix "${{ steps.patch.outputs.patch_path }}"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then
            npm ci
          elif [ -f pnpm-lock.yaml ]; then
            corepack enable
            pnpm install --frozen-lockfile
          elif [ -f yarn.lock ]; then
            corepack enable
            yarn install --frozen-lockfile
          else
            npm install
          fi

      - name: Run tests
        shell: bash
        run: |
          set -euo pipefail
          npm run -s test --if-present

      - name: Build
        shell: bash
        run: |
          set -euo pipefail
          npm run -s build --if-present

      - name: Commit changes
        shell: bash
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "No changes after applying patch"
            exit 0
          fi
          git add -A
          git commit -m "task:${{ matrix.task }}"

      - name: Push branch
        shell: bash
        run: |
          set -euo pipefail
          git push origin "${{ steps.branch.outputs.branch }}" --force

      - name: Create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          gh pr create \
            --base "${{ env.BASE_BRANCH }}" \
            --head "${{ steps.branch.outputs.branch }}" \
            --title "React Evolution: ${{ matrix.task }}" \
            --body "Automated change set for ${{ matrix.task }} via ChatGPT. No Tailwind, no Lucide."